# syntax=docker/dockerfile:1

# Build agent binary
ARG VERSION="dev"
ARG REVISION="unknown"

FROM golang:1.25-alpine AS agent-builder
ARG BUILD_TAGS="exclude_frontend"
WORKDIR /build

RUN apk add --no-cache git ca-certificates tzdata curl

COPY ./.version ./VERSION
COPY ./backend/go.mod ./backend/go.sum ./
RUN go mod download

COPY ./backend ./backend

WORKDIR /build/backend
RUN --mount=type=cache,target=/root/.cache/go-build \
    VERSION=$(cat ../VERSION | tr -d '[:space:]') && \
    REVISION=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown") && \
    CGO_ENABLED=0 GOOS=linux \
    go build \
    -tags "${BUILD_TAGS}" \
    -ldflags "-w -s -X github.com/ofkm/arcane-backend/internal/config.Version=${VERSION} -X github.com/ofkm/arcane-backend/internal/config.Revision=${REVISION}" \
    -trimpath \
    -o /out/arcane-agent \
    ./cmd/main.go

FROM alpine:3 AS agent
RUN apk upgrade && apk --no-cache add ca-certificates tzdata curl gcompat

WORKDIR /app
RUN mkdir -p /app/data

COPY --from=agent-builder /out/arcane-agent /usr/local/bin/arcane-agent

ARG VERSION="dev"
ARG REVISION="unknown"

# Multi-distro, multi-arch library path for GPU support
# Includes paths for: NVIDIA runtime mounts, Debian/Ubuntu (AMD64/ARM64), RHEL/CentOS/Fedora, Arch, and standard fallbacks
# Covers: NVIDIA GPUs (all distros/architectures), future AMD ROCm support, and Intel GPU support
ENV LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/opt/rocm/lib:/usr/lib/x86_64-linux-gnu:/usr/lib/aarch64-linux-gnu:/usr/lib64:/usr/lib:/lib64:/lib

ENV ENVIRONMENT=production \
    AGENT_MODE=true \
    GIN_MODE=release \
    PORT=3553

LABEL org.opencontainers.image.authors="OFKM Technologies"
LABEL org.opencontainers.image.url="https://github.com/getarcaneapp/arcane"
LABEL org.opencontainers.image.documentation="https://github.com/getarcaneapp/arcane/blob/main/README.md"
LABEL org.opencontainers.image.source="https://github.com/getarcaneapp/arcane"
LABEL org.opencontainers.image.version=$VERSION
LABEL org.opencontainers.image.revision=$REVISION
LABEL org.opencontainers.image.licenses="BSD-3-Clause"
LABEL org.opencontainers.image.ref.name="arcane-agent"
LABEL org.opencontainers.image.title="Arcane Agent"
LABEL org.opencontainers.image.description="Arcane Agent"

LABEL com.ofkm.arcane.updater="false"
LABEL com.ofkm.arcane.server="true"

EXPOSE 3553
VOLUME ["/app/data"]

CMD ["/usr/local/bin/arcane-agent"]